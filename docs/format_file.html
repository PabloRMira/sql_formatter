---

title: format_file


keywords: fastai
sidebar: home_sidebar

summary: "Functions to format a SQL file with multiple queries and SQL statements"
description: "Functions to format a SQL file with multiple queries and SQL statements"
nb_path: "nbs/01_format_file.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/01_format_file.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Use-Case">Use-Case<a class="anchor-link" href="#Use-Case"> </a></h2><p>Assume you have a file called sql_file.sql containing SQL statements and queries.</p>
<p>After reading it in python we could have something like this:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sql_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">--- Views for some nice data mart ---</span>
<span class="s2">use database my_database;</span>
<span class="s2">use schema my_schema;</span>

<span class="s2">create or replace view first_view as -- my first view</span>
<span class="s2">select a.car_id,</span>
<span class="s2">       b.car_name, sum(a.price) over (partition by b.car_name order by a.car_id) as sum_price, a.price,</span>
<span class="s2">from sales as a left join (select car_id, car_name, from cars) as b </span>
<span class="s2">on a.car_id = b.car_id</span>
<span class="s2">where car_id&gt;1 and car_id&lt;=100 order by b.car_name;</span>

<span class="s2">-- Table no. 1 --</span>
<span class="s2">create or replace table first_table as -- my first table</span>
<span class="s2">select car_id,</span>
<span class="s2">       avg(price) as avg_price,</span>
<span class="s2">from first_view</span>
<span class="s2">group by car_id order by car_id;</span>

<span class="s2">--- End of file ---</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we would like to format the SQL-queries in this file, while letting every other non-query-SQL statement untouched. For the example above we would like to have something like this:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">expected_sql_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">--- Views for some nice data mart ---</span>
<span class="s2">use database my_database;</span>
<span class="s2">use schema my_schema;</span>


<span class="s2">CREATE OR REPLACE VIEW first_view AS -- my first view</span>
<span class="s2">SELECT a.car_id,</span>
<span class="s2">       b.car_name,</span>
<span class="s2">       sum(a.price) OVER (PARTITION BY b.car_name</span>
<span class="s2">                          ORDER BY a.car_id) as sum_price,</span>
<span class="s2">       a.price</span>
<span class="s2">FROM   sales as a</span>
<span class="s2">    LEFT JOIN (SELECT car_id,</span>
<span class="s2">                      car_name</span>
<span class="s2">               FROM   cars) as b</span>
<span class="s2">        ON a.car_id = b.car_id</span>
<span class="s2">WHERE  car_id &gt; 1</span>
<span class="s2">   and car_id &lt;= 100</span>
<span class="s2">ORDER BY b.car_name;</span>


<span class="s2">-- Table no. 1 --</span>
<span class="s2">CREATE OR REPLACE TABLE first_table AS -- my first table</span>
<span class="s2">SELECT car_id,</span>
<span class="s2">       avg(price) as avg_price</span>
<span class="s2">FROM   first_view</span>
<span class="s2">GROUP BY car_id</span>
<span class="s2">ORDER BY car_id;</span>

<span class="s2">--- End of file ---</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To simplify the problem, we assume for the moment the user is kind enough to separate every SQL statement by a semicolon (;)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Formatting-philosophy-of-SQL-files">Formatting philosophy of SQL files<a class="anchor-link" href="#Formatting-philosophy-of-SQL-files"> </a></h3><ul>
<li>Every SQL-query is separated from above and below by two new lines</li>
<li>Every SQL-query is formatted via <a href="/sql_formatter/core.html#format_sql"><code>format_sql</code></a></li>
</ul>
<p>So our first step is to identify the lines corresponding to the SQL queries</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Formatting-Functions">Formatting Functions<a class="anchor-link" href="#Formatting-Functions"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Main-function-formatting-SQL-commands">Main function formatting SQL commands<a class="anchor-link" href="#Main-function-formatting-SQL-commands"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="format_sql_commands" class="doc_header"><code>format_sql_commands</code><a href="https://github.com/PabloRMira/sql_formatter/tree/master/sql_formatter/format_file.py#L13" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>format_sql_commands</code>(<strong><code>s</code></strong>)</p>
</blockquote>
<p>Format SQL commands in <code>s</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">assert_and_print</span><span class="p">(</span>
    <span class="n">format_sql_commands</span><span class="p">(</span><span class="n">sql_file</span><span class="p">),</span>
    <span class="n">expected_sql_file</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>--- Views for some nice data mart ---
use database my_database;
use schema my_schema;


CREATE OR REPLACE VIEW first_view AS -- my first view
SELECT a.car_id,
       b.car_name,
       sum(a.price) OVER (PARTITION BY b.car_name
                          ORDER BY a.car_id) as sum_price,
       a.price
FROM   sales as a
    LEFT JOIN (SELECT car_id,
                      car_name
               FROM   cars) as b
        ON a.car_id = b.car_id
WHERE  car_id &gt; 1
   and car_id &lt;= 100
ORDER BY b.car_name;


-- Table no. 1 --
CREATE OR REPLACE TABLE first_table AS -- my first table
SELECT car_id,
       avg(price) as avg_price
FROM   first_view
GROUP BY car_id
ORDER BY car_id;

--- End of file ---

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">assert_and_print</span><span class="p">(</span>
    <span class="n">format_sql_commands</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">use database my_database;</span>

<span class="s2">/*skip-formatter*/</span>
<span class="s2">create Or replace View my_view aS</span>
<span class="s2">select asdf, qwer</span>
<span class="s2">from table1;</span>

<span class="s2">create or replace table my_table As</span>
<span class="s2">Select asdf, qwer</span>
<span class="s2">From table2</span>
<span class="s2">group by asdf;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="sd">&quot;&quot;&quot;use database my_database;</span>

<span class="sd">/*skip-formatter*/</span>
<span class="sd">create Or replace View my_view aS</span>
<span class="sd">select asdf, qwer</span>
<span class="sd">from table1;</span>


<span class="sd">CREATE OR REPLACE TABLE my_table AS</span>
<span class="sd">SELECT asdf,</span>
<span class="sd">       qwer</span>
<span class="sd">FROM   table2</span>
<span class="sd">GROUP BY asdf;</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>use database my_database;

/*skip-formatter*/
create Or replace View my_view aS
select asdf, qwer
from table1;


CREATE OR REPLACE TABLE my_table AS
SELECT asdf,
       qwer
FROM   table2
GROUP BY asdf;

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">assert_and_print</span><span class="p">(</span>
    <span class="n">format_sql_commands</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">create or replace table my_table As</span>
<span class="s2">Select asdf, qwer</span>
<span class="s2">From table2</span>
<span class="s2">group by asdf;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">CREATE OR REPLACE TABLE my_table AS</span>
<span class="sd">SELECT asdf,</span>
<span class="sd">       qwer</span>
<span class="sd">FROM   table2</span>
<span class="sd">GROUP BY asdf;</span>
<span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CREATE OR REPLACE TABLE my_table AS
SELECT asdf,
       qwer
FROM   table2
GROUP BY asdf;

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Function-to-format-1-SQL-file">Function to format 1 SQL file<a class="anchor-link" href="#Function-to-format-1-SQL-file"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="format_sql_file" class="doc_header"><code>format_sql_file</code><a href="https://github.com/PabloRMira/sql_formatter/tree/master/sql_formatter/format_file.py#L33" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>format_sql_file</code>(<strong><code>f</code></strong>)</p>
</blockquote>
<p>Format file <code>f</code> with SQL commands and overwrite the file.
Return 0 for no change and 1 for formatting adjustments</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sql_file</span><span class="p">)</span>
<span class="n">format_sql_file</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">formatted_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">assert_and_print</span><span class="p">(</span>
    <span class="n">formatted_file</span><span class="p">,</span>
    <span class="n">expected_sql_file</span>
<span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>--- Views for some nice data mart ---
use database my_database;
use schema my_schema;


CREATE OR REPLACE VIEW first_view AS -- my first view
SELECT a.car_id,
       b.car_name,
       sum(a.price) OVER (PARTITION BY b.car_name
                          ORDER BY a.car_id) as sum_price,
       a.price
FROM   sales as a
    LEFT JOIN (SELECT car_id,
                      car_name
               FROM   cars) as b
        ON a.car_id = b.car_id
WHERE  car_id &gt; 1
   and car_id &lt;= 100
ORDER BY b.car_name;


-- Table no. 1 --
CREATE OR REPLACE TABLE first_table AS -- my first table
SELECT car_id,
       avg(price) as avg_price
FROM   first_view
GROUP BY car_id
ORDER BY car_id;

--- End of file ---

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Function-to-format-many-SQL-files">Function to format many SQL files<a class="anchor-link" href="#Function-to-format-many-SQL-files"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="format_sql_files" class="doc_header"><code>format_sql_files</code><a href="https://github.com/PabloRMira/sql_formatter/tree/master/sql_formatter/format_file.py#L48" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>format_sql_files</code>(<strong><code>files</code></strong>:"Path to SQL files")</p>
</blockquote>
<p>Format SQL <code>files</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sql_file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;tmp2&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sql_file</span><span class="p">)</span>
<span class="n">format_sql_files</span><span class="p">([</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;tmp2&quot;</span><span class="p">])</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">formatted_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">assert_and_print</span><span class="p">(</span>
    <span class="n">formatted_file</span><span class="p">,</span>
    <span class="n">expected_sql_file</span>
<span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;tmp2&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">formatted_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">assert_and_print</span><span class="p">(</span>
    <span class="n">formatted_file</span><span class="p">,</span>
    <span class="n">expected_sql_file</span>
<span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp2&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>All done!
--- Views for some nice data mart ---
use database my_database;
use schema my_schema;


CREATE OR REPLACE VIEW first_view AS -- my first view
SELECT a.car_id,
       b.car_name,
       sum(a.price) OVER (PARTITION BY b.car_name
                          ORDER BY a.car_id) as sum_price,
       a.price
FROM   sales as a
    LEFT JOIN (SELECT car_id,
                      car_name
               FROM   cars) as b
        ON a.car_id = b.car_id
WHERE  car_id &gt; 1
   and car_id &lt;= 100
ORDER BY b.car_name;


-- Table no. 1 --
CREATE OR REPLACE TABLE first_table AS -- my first table
SELECT car_id,
       avg(price) as avg_price
FROM   first_view
GROUP BY car_id
ORDER BY car_id;

--- End of file ---

--- Views for some nice data mart ---
use database my_database;
use schema my_schema;


CREATE OR REPLACE VIEW first_view AS -- my first view
SELECT a.car_id,
       b.car_name,
       sum(a.price) OVER (PARTITION BY b.car_name
                          ORDER BY a.car_id) as sum_price,
       a.price
FROM   sales as a
    LEFT JOIN (SELECT car_id,
                      car_name
               FROM   cars) as b
        ON a.car_id = b.car_id
WHERE  car_id &gt; 1
   and car_id &lt;= 100
ORDER BY b.car_name;


-- Table no. 1 --
CREATE OR REPLACE TABLE first_table AS -- my first table
SELECT car_id,
       avg(price) as avg_price
FROM   first_view
GROUP BY car_id
ORDER BY car_id;

--- End of file ---

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

